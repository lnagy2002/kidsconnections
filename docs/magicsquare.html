<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Daily Magic Squares</title>
    <style>
    @import url('./theme.css');
         :root {
            --ink-2: #143f57;
            --accent: #f0db79;
            /* soft teal like your kidsconnections vibe */
            --accent-2: #f0db79;
            /* coral accent for highlights */
        }

        .board {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px
        }

        .prompt {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr minmax(260px, 340px);
        }

        .pane {
            background: var(--muted);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .pane canvas,
        .grid canvas {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            height: auto;
            max-height: 380px;
            object-fit: contain
        }

        .meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap
        }

        .badge {
            background: #eef6ff;
            color: #0e364b;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .opt {
            position: relative;
            background: var(--muted);
            border-radius: 16px;
            padding: 10px;
            cursor: pointer;
            overflow: hidden;
            transition: transform .1s ease, box-shadow .2s ease;
        }

        .opt:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, .12)
        }

        .opt.selected.correct {
            /* outline: 5px solid var(--ok); */
            background-color: var(--ok);
        }

        .opt.selected.wrong {
            /* outline: 5px solid var(--bad) */
            background-color: var(--bad);
        }

        .opt label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #fff;
            border-radius: 999px;
            font-size: 12px;
            padding: 4px 8px
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px
        }

        .hint {
            font-size: 13px;
            color: #2f4454
        }

        .score {
            color: #fff;
            font-weight: 600
        }

        @media (max-width:840px) {
            .prompt {
                grid-template-columns: 1fr
            }
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .section {
            margin-top: 15px;
            text-align: center;
        }

        .muted {
            color: var(--muted);
            text-align: center;
        }
        /* Shake animation for incorrect entries */

        @keyframes shake {
            10%,
            90% {
                transform: translateX(-2px);
            }
            20%,
            80% {
                transform: translateX(4px);
            }
            30%,
            50%,
            70% {
                transform: translateX(-6px);
            }
            40%,
            60% {
                transform: translateX(6px);
            }
            100% {
                transform: translateX(0);
            }
        }

        .shake {
            /* animation: shake 300ms ease; */
            background: var(--bad) !important;
        }

        /* Card container */

        .card {
            /* padding: 18px 18px 22px;
            margin: 0 auto 18px; */
            text-align: center;
        }
        /* Level buttons styled bold like your controls */

        .levels {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 6px 0 10px;
        }
        /* Board grid */

        .board {
            display: grid;
            gap: 8px;
            justify-content: center;
            margin: 16px auto 8px;
        }

        .cell {
            width: 64px;
            height: 64px;
            border: 2px solid var(--bg);
            border-radius: 12px;
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            outline: none;
            background: white;
        }

        .cell:disabled {
            background: var(--accent);
            color: #2a556c;
            border: 2px solid var(--bg);
            opacity: 1; /* override iOS Safari dimming */
            -webkit-text-fill-color: #666; /* fixes iOS Safari gray text */
        }
        /* .rowSums, .colSums{
      display:flex; gap:8px; justify-content:center; margin:8px 0 0;
      color:var(--muted); font-size:14px;
    } */

        .message {
            /* font-weight:800; margin-top:10px; min-height:24px; */
            color: var(--muted);
        }

        .ok {
            color: var(--ok)
        }

        .bad {
            color: #b33a33
        }


    </style>
    <link rel="stylesheet" href="https://lnagy2002.github.io/kidsconnections/games-utils.css">
    <script src="https://lnagy2002.github.io/kidsconnections/games-menu.js" defer data-menu="https://lnagy2002.github.io/kidsconnections/games-menu.json"></script>
    <script src="https://lnagy2002.github.io/kidsconnections/games-utils.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KFSR46Z6C8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'G-KFSR46Z6C8');
    </script>

</head>

<body>
    <main class="main">
        <div>
          <script src="https://lnagy2002.github.io/kidsconnections/header.js" data-title="Magic Squares"></script>
        </div>
        <h3 class="section">Make all lines add up to the target number <span id="target" style="font-size: 1.75rem; font-weight:900"></span></h3>
        <div class="card">

            <div id="board" class="board"></div>

            <!-- <div class="rowSums" id="rowSums"></div>
      <div class="colSums" id="colSums"></div> -->
            <div id="status" class="muted" style="margin-top: 20px"></div>

            <h4 id="message" class="bad" style="margin-left:auto"></h4>
        </div>
    </main>
    <div>
      <script src="https://lnagy2002.github.io/kidsconnections/footer.js"></script>
    </div>

    <script>
    const LEVELS = {
      easy:   { size: 3},
      medium: { size: 4},
      hard:   { size: 5}
    };

        /** ---------- Daily seed & RNG ---------- */
        function todaySeed() {
            const d = new Date();
            return d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
        }

        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        let rand = mulberry32(todaySeed());

        /** ---------- Magic square generators ---------- */
        function magicOdd(n) {
            const grid = Array.from({
                length: n
            }, () => Array(n).fill(0));
            let num = 1,
                i = 0,
                j = Math.floor(n / 2);
            while (num <= n * n) {
                grid[i][j] = num++;
                let ni = (i - 1 + n) % n;
                let nj = (j + 1) % n;
                if (grid[ni][nj] !== 0) {
                    i = (i + 1) % n;
                } else {
                    i = ni;
                    j = nj;
                }
            }
            return grid;
        }

        function magicDoublyEven(n) {
            const grid = Array.from({
                length: n
            }, (_, r) => Array.from({
                length: n
            }, (_, c) => r * n + c + 1));
            const total = n * n + 1;
            for (let r = 0; r < n; r++) {
                for (let c = 0; c < n; c++) {
                    if ((r % 4 === 0 || r % 4 === 3) && (c % 4 === 0 || c % 4 === 3) ||
                        (r % 4 === 1 || r % 4 === 2) && (c % 4 === 1 || c % 4 === 2)) {
                        grid[r][c] = total - grid[r][c];
                    }
                }
            }
            return grid;
        }

        function makeMagic(n) {
          console.log (n)
            if (n % 2 === 1) return magicOdd(n);
            if (n % 4 === 0) return magicDoublyEven(n);
            throw new Error("Unsupported size " + n);
        }

        /** ---------- Build daily puzzle from a valid solution ---------- */
        function seededShuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(rand() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function makePuzzle(n, difficulty) {
            const solution = makeMagic(n);
            const flatIdx = Array.from({
                length: n * n
            }, (_, k) => k);
            seededShuffle(flatIdx);

            let blanks;
            if (difficulty === "easy") blanks = Math.floor(n * n * 0.35);
            else if (difficulty === "medium") blanks = Math.floor(n * n * 0.5);
            else blanks = Math.floor(n * n * 0.6);

            const blankSet = new Set(flatIdx.slice(0, blanks));
            const givens = Array.from({
                length: n
            }, () => Array(n).fill(null));
            for (let r = 0; r < n; r++) {
                for (let c = 0; c < n; c++) {
                    const k = r * n + c;
                    givens[r][c] = blankSet.has(k) ? null : solution[r][c];
                }
            }
            return {
                solution,
                givens,
                n
            };
        }

        /** ---------- UI ---------- */
        const boardEl = document.getElementById("board");
        // const rowSumsEl = document.getElementById("rowSums");
        // const colSumsEl = document.getElementById("colSums");
        const statusEl = document.getElementById("status");
        const targetEl = document.getElementById("target");
        const messageEl = document.getElementById("message");

        let current = {
            n: 3,
            puzzle: null
        };

        function start(level) {
            const size =  LEVELS[level].size;
            rand = mulberry32(todaySeed() + size * 99991);

            current.n = size;
            console.log  (level, size)
            current.puzzle = makePuzzle(size, level);
            renderBoard(current.puzzle);
            document.querySelectorAll(".levels .btn").forEach(b => {
                b.classList.toggle("secondary", parseInt(b.dataset.size, 10) !== size);
            });
        }

        function renderBoard(puz) {
            const n = puz.n;
            boardEl.style.gridTemplateColumns = `repeat(${n}, 64px)`;
            boardEl.innerHTML = "";
            // rowSumsEl.innerHTML = "";
            // colSumsEl.innerHTML = "";
            statusEl.textContent = "";

            const M = (n * (n * n + 1)) / 2; // magic constant
            targetEl.innerHTML = `<span class="ok">${M}</span>`;

            for (let r = 0; r < n; r++) {
                for (let c = 0; c < n; c++) {
                    const cell = document.createElement("input");
                    cell.className = "cell";
                    cell.type = "text";
                    cell.inputMode = "numeric";
                    cell.maxLength = 2;
                    cell.dataset.r = r;
                    cell.dataset.c = c;

                    const given = puz.givens[r][c];
                    if (given != null) {
                        cell.value = given;
                        cell.disabled = true;
                    } else {
                        cell.addEventListener("input", () => {
                            cell.value = cell.value.replace(/[^0-9]/g, "").slice(0, 2);
                            // Only validate when there is a value (donâ€™t shake on empty)
                            if (cell.value) validateCell(cell);
                            checkProgress();
                        });
                        cell.addEventListener("blur", () => {
                            if (cell.value) validateCell(cell);
                            checkProgress();
                        });
                    }
                    boardEl.appendChild(cell);
                }
            }
            // for(let i=0;i<n;i++){
            //   const span = document.createElement("div"); span.textContent = `Row ${i+1}: â€”`;
            //   rowSumsEl.appendChild(span);
            // }
            // for(let i=0;i<n;i++){
            //   const span = document.createElement("div"); span.textContent = `Col ${i+1}: â€”`;
            //   colSumsEl.appendChild(span);
            // }
            checkProgress();
        }

        function gridFromInputs() {
            const cells = Array.from(boardEl.querySelectorAll(".cell"));
            const n = current.n;
            const grid = Array.from({
                length: n
            }, () => Array(n).fill(0));
            for (const cell of cells) {
                const r = +cell.dataset.r,
                    c = +cell.dataset.c;
                const v = cell.value ? parseInt(cell.value, 10) : 0;
                grid[r][c] = v;
            }
            return grid;
        }

        const n = current.n;
        /** ---------- Shake + clear helper ---------- */

        function shakeAndClearRangeOrUnique(cell) {
            console.log ("shakeAndClearRangeOrUnique", cell)
            cell.classList.remove("shake"); // restart animation if already set
            // force reflow to restart animation
            void cell.offsetWidth;
            cell.classList.add("shake");
            messageEl.innerHTML = "Numbers must be 1.." + (n * n) + " with no repeats.";
            // setTimeout(()=>{ cell.classList.remove("shake1"); }, 1024);
        }


        function shakeAndClearSum(cell) {
            // force reflow to restart animation
            console.log ("--> sum is incorect")
            cell.classList.remove("shake2"); // restart animation if already set
            void cell.offsetWidth;
            cell.classList.add("shake2");
            setTimeout(()=>{ cell.classList.remove("shake2"); }, 320);
        }

        /** ---------- Cell validation (per-entry) ---------- */
        function validateCell(cell) {
            console.log  ("validate cell", cell)
            cell.classList.remove("shake"); // restart animation if already set
            messageEl.innerHTML = "";
            const n = current.n;
            const M = (n * (n * n + 1)) / 2;
            const r = +cell.dataset.r;
            const c = +cell.dataset.c;
            const v = parseInt(cell.value, 10);
            if (!v) {
                return;
            }

            // Range check
            if (v < 1 || v > n * n) {
                shakeAndClearRangeOrUnique(cell);
                return;
            }

            // Uniqueness check (no duplicates among all editable & given)
            const cells = Array.from(boardEl.querySelectorAll(".cell"));
            for (const other of cells) {
                if (other === cell) continue;
                const ov = parseInt(other.value, 10);
                if (ov && ov === v) {
                    shakeAndClearRangeOrUnique(cell);
                    return;
                }
            }

            // Build grid with this tentative value
            const grid = gridFromInputs();

            // Row/Column partial & final checks
            // Row
            let rowSum = 0,
                rowZeros = 0;
            for (let j = 0; j < n; j++) {
                if (grid[r][j] === 0) rowZeros++;
                rowSum += grid[r][j];
            }
            if (rowSum > M) {
                shakeAndClearSum(cell);
                return;
            }
            if (rowZeros === 0 && rowSum !== M) {
                // shakeAndClear3(cell);
                return;
            }

            // Column
            let colSum = 0,
                colZeros = 0;
            for (let i = 0; i < n; i++) {
                if (grid[i][c] === 0) colZeros++;
                colSum += grid[i][c];
            }
            if (colSum > M) {
                shakeAndClearSum(cell);
                return;
            }
            if (colZeros === 0 && colSum !== M) {
                // shakeAndClear3(cell);
                return;
            }

            // Diagonals if applicable
            // Main diag
            if (r === c) {
                let dSum = 0,
                    dZeros = 0;
                for (let i = 0; i < n; i++) {
                    if (grid[i][i] === 0) dZeros++;
                    dSum += grid[i][i];
                }
                if (dSum > M) {
                    shakeAndClearSum(cell);
                    return;
                }
                if (dZeros === 0 && dSum !== M) {
                    // shakeAndClear3(cell);
                    return;
                }
            }
            // Anti-diag
            if (r + c === n - 1) {
                let dSum = 0,
                    dZeros = 0;
                for (let i = 0; i < n; i++) {
                    const x = grid[i][n - 1 - i];
                    if (x === 0) dZeros++;
                    dSum += x;
                }
                if (dSum > M) {
                    shakeAndClearSum(cell);
                    return;
                }
                if (dZeros === 0 && dSum !== M) {
                    // shakeAndClear3(cell);
                    return;
                }
            }
            // If we got here, current entry is acceptable (no shake)
        }

        /** ---------- Progress / win check ---------- */
        function checkProgress() {
            const n = current.n;
            const M = (n * (n * n + 1)) / 2;
            const grid = gridFromInputs();

            // for(let r=0;r<n;r++){
            //   const s = grid[r].reduce((a,b)=>a+b,0);
            //   rowSumsEl.children[r].textContent = `Row ${r+1}: ${s}`;
            // }
            // for(let c=0;c<n;c++){
            //   let s=0; for(let r=0;r<n;r++) s += grid[r][c];
            //   colSumsEl.children[c].textContent = `Col ${c+1}: ${s}`;
            // }

            const used = new Set();
            let allFilled = true,
                validRange = true,
                uniqueOK = true;
            for (let r = 0; r < n; r++) {
                for (let c = 0; c < n; c++) {
                    const v = grid[r][c];
                    if (v === 0) {
                        allFilled = false;
                    }
                    if (v < 0 || v > n * n) {
                        validRange = false;
                    }
                    if (v !== 0) {
                        if (used.has(v)) {
                            uniqueOK = false;
                        }
                        used.add(v);
                    }
                }
            }

            if (!allFilled) {
                statusEl.className = "message";
                statusEl.innerHTML = "Fill the blanks so every line sums to target sum.";
                return;
            }

            if (!validRange || !uniqueOK) {
                // statusEl.className = "message bad";
                // statusEl.textContent = "Numbers must be 1.." + (n * n) + " with no repeats.";
                return;
            }

            for (let r = 0; r < n; r++) {
                const s = grid[r].reduce((a, b) => a + b, 0);
                if (s !== M) {
                    statusEl.className = "message bad";
                    statusEl.textContent = "Not quiteâ€”some rows donâ€™t match the target yet.";
                    return;
                }
            }
            for (let c = 0; c < n; c++) {
                let s = 0;
                for (let r = 0; r < n; r++) s += grid[r][c];
                if (s !== M) {
                    statusEl.className = "message bad";
                    statusEl.textContent = "Keep goingâ€”some columns donâ€™t match the target yet.";
                    return;
                }
            }
            let d1 = 0,
                d2 = 0;
            for (let i = 0; i < n; i++) {
                d1 += grid[i][i];
                d2 += grid[i][n - 1 - i];
            }
            if (d1 !== M || d2 !== M) {
                statusEl.className = "message bad";
                statusEl.textContent = "Almostâ€”check the diagonals.";
                return;
            }


            statusEl.className = "message ok";
            statusEl.textContent = "ðŸŽ‰ Magic complete! Fantastic work.";
            celebrate();
        }


        document.addEventListener("DOMContentLoaded", () => {
          const dateEl = document.getElementById("date");
          if (dateEl) {
            const level = getQueryParam('level') || 'easy';
            // default start (Easy)
            // const n = +level;
            start(level);
          }
        });

        if (window.self !== window.top) {
          document.body.classList.add('embedded');
        }
    </script>
</body>

</html>
